define(["core/ajax"],function(e){"use strict";function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=t(e);const{call:a}=n.default,s=e=>{const t=new Map;return{getElement(n){const a=`${n}-${e}`;return t.has(a)||t.set(a,document.getElementById(a)),t.get(a)},setElement(e,t){const n=this.getElement(e);n&&(n.innerHTML=t)},setButtonState(e,t,n,a=(t?"0.7":"1")){const s=this.getElement(e);s&&(s.disabled=t,s.textContent=n,s.style.opacity=a,s.style.cursor=t?"not-allowed":"pointer")}}};return{authorizeDotNetPayment:function(e,t,n,o,r){const c=s(e),d=c.getElement("payment_form");if(!d)return void console.error("Payment form not found!");const l=async t=>{t.preventDefault(),c.setButtonState("paybutton",!0,r),c.setElement("payment_error","");try{const t=await(e=>a([{methodname:"enrol_authorizedotnet_get_hosted_form_token",args:{instanceid:e}}])[0])(e);if(!t.status)throw new Error(t.message||"Failed to get payment token.");const n={hostedPage:{dataValue:t.token,dataDescriptor:"COMMON.ACCEPT.HOSTED.PAYMENTPAGE"}};Accept.dispatchData(n)}catch(e){c.setElement("payment_error",e.message||"An unexpected error occurred during payment."),c.setButtonState("paybutton",!1,o)}},m=async t=>{if("Ok"===t.messages.resultCode){const n=t.opaqueData;try{const t=await((e,t,n)=>a([{methodname:"enrol_authorizedotnet_finalize_enrollment",args:{instanceid:e,dataDescriptor:t,dataValue:n}}])[0])(e,n.dataDescriptor,n.dataValue);t.status?window.location.href=t.redirecturl:c.setElement("payment_error",t.message||"Enrollment failed.")}catch(e){c.setElement("payment_error",e.message||"An unexpected error occurred during enrollment.")}}else{let e="Payment failed or was cancelled.";t.messages.message&&t.messages.message.length>0&&(e=t.messages.message[0].text),c.setElement("payment_error",e)}c.setButtonState("paybutton",!1,o)};d.addEventListener("submit",l),window.addEventListener("message",e=>{"handleResponse"===e.data.AcceptJSEvent&&m(e.data)})}}});
